
{% extends "django_sb_admin/base.html" %}
<!doctype html>
{% block sb_admin_header %}
  {% block branding %}
    <img src="/static/Riyadh-metro-logo.png" style="background: transparent;width: 60px;">
    <!-- <h1 id="site-name">Asset Optima</h1> -->
  {% endblock %}
{% endblock sb_admin_header %}
{% block sb_admin_content %}
              <!-- Page Heading -->

            <div class="row mb-3">
                <div class="col-lg-12">
                    <h3 class="page-header">
                      MOM Dated {{meeting_date}}
                    </h3>
                    <!--ol class="breadcrumb">
                        <li>
                            <i class="fa fa-dashboard"></i>  <a href="index.html">Dashboard</a>
                        </li>
                        <li class="active">
                            <i class="fa fa-edit"></i> Forms
                        </li>
                    </ol-->
                </div>
            </div>

            <div class="row ">
              <div class="col-lg-12 mb-3">
  
  
                  <a href="/forms/review_board/"><button class="btn btn-primary btn-icon-split float-right m-2" > 
                  <span class="icon text-white-50">
                      <i class="fas fa-angle-left"></i>
                      </span>             
                  <span class="text">Back</span>
                  </button></a>
              
              </div>
          </div>




            <!-- /.row -->
<div class="row mb-4 mt-4">
   <div class="col-lg-9 mb-5 m-auto" id="myChartDiv">
      <canvas class="d-none" id="myChart"></canvas>
      <h4 class="text-center">Performance of Expected failures v/s Actual failures - {{ asst }}</h4>
   </div>
</div>
<div class="row ml-4 mr-4">
   <div class="col-lg-12 card todos_labels pl-0 pr-0">
      <div class="card-header">
        <div class="row">
          <div class="col-sm-12">
            <h2 class="mb-0">List Of Defects Identified For - {{ asst }}</h2>
          </div>               
        </div>      
      </div>

      <div class="table-responsive card-body">
         <table class="table table-bordered table-hover table-striped">
            <thead>
               <tr>
                  <th>Defect ID</th>
                  <th>Defect Description</th>
                  <th>Defect Open</th>
                  <th>Defect Closed Date</th>
                  <th>Investigation</th>
                  <th>Defect Status</th>
                  <th>Defect Status Remarks</th>
                  <th>Oem Defect Reference</th>
                  <th>Oem Target Date</th>
               </tr>
            </thead>
            <tbody>
               {% for defect in defects %}
               <tr>
                  <td>{{defect.defect_id}}</td>
                  <td>{{defect.defect_description}}</td>
                  <td>{{defect.defect_open_date}}</td>
                  <td>{{defect.defect_closed_date}}</td>
                  <td>{{defect.investigation}}</td>
                  <td>{{defect.defect_status}}</td>
                  <td>{{defect.defect_status_remarks}}</td>
                  <td>{{defect.oem_defect_reference}}</td>
                  <td>{{defect.oem_target_date}}</td>
               </tr>
               
               {% endfor %}
            </tbody>
         </table>
      </div>
   </div>
</div>
 <div class="row mt-5 ml-1 mr-1">
   <div class="col-lg-12 inline-group" id="defectdiscussion_set-group">
      <div class="tabular inline-related last-related" id="defectdiscussion_set">
        <form class="form-horizontal">
         <fieldset class="module card todos_labels pl-0">
            <div class="col-sm-12 card-header pl-0 pr-0">
              <div class="row">
                <div class="col-sm-4">
                  <h2 class="mb-0">Defect Discussions 
                    <a href="javascript:void(0)" onclick="addEditAttendees('');">Add New <i class="fa fa-plus" aria-hidden="true"></i></a>
                  </h2>
                </div>
                <!-- <div class="col-sm-8">
                  <input type="button" class="btn btn-success span-2 float-right mr-3 pt-1" value="Add New Discussion" onclick="addEditAttendees('');"/>
                </div>                -->
              </div>
              
            </div>
            
            <div class="card-body">
              <!-- <div class="col-sm-12">
               <input type="button" class="btn btn-success span-2 float-right mb-4" value="Add New Discussion" onclick="addEditAttendees('');"/>
              </div> -->
              <input type="hidden" name="review_board_id" id="review_board_id" value="{{review_board.id}}">
                <div id="exTab2" class="container p-0"> 
                    <ul class="nav nav-tabs" id="navListItems"></ul>                
                    <div id="navTabContents" class="tab-content p-4" style="border: 1px solid #dee2e6; border-top: 0;"></div>
                </div>
              <!-- <div id="attendeesListDiv"></div> -->
          
         </fieldset>

       </form>
      </div>
   </div>
</div>
<div class="row mt-5 ml-1 mr-1">
  <div class="col-sm-12">
    <!-- <form> -->
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="meeting_outcome">Meeting Outcome-</label>
            <input type="text" name="meeting_outcome" class="form-control" id="meeting_outcome" value="{{review_board.meeting_outcome}}">
          </div>
          <div class="form-group col-md-6">
            <label for="meeting_status">Defect Status</label>
            <input type ="hidden" id="reviewBoardStatusHdn" value="{{ review_board.meeting_status }}">
            <select name="meeting_status" class="form-control" id="meeting_status">
              <option value="">Select Status</option>
              <option value="Open">Open</option>
              <option value="Resolved">Resolved</option>
              <option value="Update">Update</option>
              <option value="Monitoring">Monitoring</option>
              <option value="Closed">Closed</option>
            </select>
          </div>
        </div>
        <div class="row mb-4" align="right">
          <div class="col-12">  
            <input type="button" class="btn btn-danger mt-2" value="Delete" onclick="deleteMeetingData({{review_board.id}});">
              <button type="submit" class="btn btn-primary mt-2" onclick="saveMeetingData({{review_board.id}},1);">Save</button>
                      
              <button type="submit" class="btn btn-primary mt-2" onclick="saveMeetingData({{review_board.id}},2);">Save and continue editing</button>
          </div>
      </div>
       
    <!-- </form> -->
  </div>
</div>

</div>
<div class="modal fade" id="addEditAttendeesModal" tabindex="-1" role="dialog" aria-labelledby="addReviewModalLabel" aria-hidden="true">
   <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Add New Discussion</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
         </div>
         <div class="modal-body">
            <form>
            <div class = "form-group">
              <label for = "firstname" class = "col-sm-2 control-label">Attendees</label>
              <div class = "col-sm-12">
                 <div class="related-widget-wrapper">
                              <div class="row ml-2">
                                 <div class="col-xs-5 col-md-5">
                                    <select name="lstview" id="lstview" class="form-control" size="13" multiple="multiple">
                                      {% for employe in employees %}
                                       <option value="{{employe.id}}">{{employe.first_name}} {{employe.last_name}}</option>
                                      {% endfor %}
                                    </select>
                                 </div>
                                 <div class="col-xs-2 select_actions">
                                    <button type="button" id="lstview_undo" class="btn btn-danger btn-block">undo</button>
                                    <button type="button" id="lstview_rightAll" class="btn btn-default btn-block"><i class="fa fa-forward"></i></button>
                                    <button type="button" id="lstview_rightSelected" class="btn btn-default btn-block"><i class="fa fa-chevron-right"></i></button>
                                    <button type="button" id="lstview_leftSelected" class="btn btn-default btn-block"><i class="fa fa-chevron-left"></i></button>
                                    <button type="button" id="lstview_leftAll" class="btn btn-default btn-block"><i class="fa fa-backward"></i></button>
                                    <button type="button" id="lstview_redo" class="btn btn-warning btn-block">redo</button>
                                 </div>
                                 <div class="col-xs-5 col-md-5">
                                    <select name="to" id="lstview_to" class="form-control" size="13" multiple="multiple"></select>
                                 </div>
                              </div>
                              <a class="related-widget-wrapper-link add-related" id="add_id_defectdiscussion_{?}" href="/fracas_admin/user/add/?_to_field=id&amp;_popup=1" title="Add another employee master"><img src="/static/admin/img/icon-addlink.svg" alt="Add"></a>
                           </div>
              </div>
           </div>
           <div class = "form-group">
            <label for = "firstname" class = "col-sm-2 control-label">Defect</label>
            <div class = "col-sm-10">
              {% if defects_count == 0 %}
                <label class="text-danger">No defect available </label>
              {% else %}
                  <select name="discussion_defect_set" id="discussion_defect_set">
                    <option value="" selected="">---------</option>
                    {% for defect in defects %}
                    <option value="{{defect.defect_id}}">{{defect.defect_id}} {{defect.defect_description}}</option>
                    {% endfor %}
                  </select>
                {% endif %}
            </div>
         </div>
            </form>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="SaveAttendees();">Save Discussion</button>
         </div>
      </div>
   </div>
</div>
<div class="modal fade" id="EditAttendeesModal" tabindex="-1" role="dialog" aria-labelledby="addReviewModalLabel" aria-hidden="true">
   <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Add New Discussion</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
         </div>
         <div class="modal-body">
            <form>
            <div class = "form-group">
              <label for = "firstname" class = "col-sm-2 control-label">Attendees</label>
              <div class = "col-sm-12">
                 <div class="related-widget-wrapper">
                              <div class="row ml-2">
                                 <div class="col-xs-5 col-md-5">
                                    <select name="lstviewEdit" id="lstviewEdit" class="form-control" size="13" multiple="multiple">
                                      {% for employe in employees %}
                                       <option value="{{employe.id}}">{{employe.first_name}} {{employe.last_name}}</option>
                                      {% endfor %}
                                    </select>
                                 </div>
                                 <div class="col-xs-2 select_actions">
                                    <button type="button" id="lstviewEdit_undo" class="btn btn-danger btn-block">undo</button>
                                    <button type="button" id="lstviewEdit_rightAll" class="btn btn-default btn-block"><i class="fa fa-forward"></i></button>
                                    <button type="button" id="lstviewEdit_rightSelected" class="btn btn-default btn-block"><i class="fa fa-chevron-right"></i></button>
                                    <button type="button" id="lstviewEdit_leftSelected" class="btn btn-default btn-block"><i class="fa fa-chevron-left"></i></button>
                                    <button type="button" id="lstviewEdit_leftAll" class="btn btn-default btn-block"><i class="fa fa-backward"></i></button>
                                    <button type="button" id="lstviewEdit_redo" class="btn btn-warning btn-block">redo</button>
                                 </div>
                                 <div class="col-xs-5 col-md-5">
                                    <select name="to" id="lstviewEdit_to" class="form-control" size="13" multiple="multiple"></select>
                                 </div>
                              </div>
                           </div>
              </div>
           </div>
           <div class = "form-group">
            <label for = "firstname" class = "col-sm-2 control-label">Defect</label>
            <div class = "col-sm-10">
               <select name="id_defectdiscussion_set" id="id_defectdiscussion_set">
                  <option value="" selected="">---------</option>
                  {% for defect in defects %}
                   <option value="{{defect.defect_id}}">{{defect.defect_id}} {{defect.defect_description}}</option>
                  {% endfor %}
                </select>
            </div>
         </div>
         </form>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="UpdateDiscussion();">Update Discussion</button>
            <input type="hidden" value="" id="discussionId_edit">
         </div>
      </div>
   </div>
</div>

<div class="modal fade" id="addNewAction" tabindex="-1" role="dialog" aria-labelledby="addReviewModalLabel" aria-hidden="true">
   <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title" id="actionModalLabel">Add New Action</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
         </div>
         <div class="modal-body">
            <form>
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label for="action_description">Action description</label>
                  <input type="text" name="action_description" class="form-control" maxlength="100" id="action_description">
                </div>
                <div class="form-group col-md-6">                  
                  <label for="action_owner">Action owner</label>
                  <!-- <input type="text" name="action_owner" class="form-control" maxlength="100" id="action_owner"> -->
                  <select name="action_owner" class="form-control" id="action_owner">
                    <option value="">Select Owner</option>
                  </select>
                </div>
              </div> 
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label for="action_status">Action status</label>
                  <!-- <input type="text" name="action_status" class="form-control" maxlength="100" id="action_status"> -->
                  <select name="action_status" class="form-control" id="action_status">
                    <option value="">Select Status</option>
                    <option value="Open">Open</option>
                    <option value="Resolved">Resolved</option>
                    <option value="Update">Update</option>
                    <option value="Monitoring">Monitoring</option>
                    <option value="Closed">Closed</option>
                  </select>
                </div>
                <div class="form-group col-md-6">
                  <label for="action_due_dat">Action due date</label>
                  <input type="text" name="action_due_dat" class="form-control" maxlength="100" id="action_due_dat">
                </div>
              </div>
              <div class="form-group">
                <label for="progress_log">Progress logs</label>
                <textarea name="progress_log" class="form-control" id="progress_log" rows="3"></textarea>
              </div> 
         </form>
         <input type="hidden" name="review_discussion_id" id="review_discussion_id" value="">
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="saveActionButton" onclick="SaveAction();">Save Action</button>
         </div>
      </div>
   </div>
</div>
{% endblock sb_admin_content %}
{% block sb_admin_js %}
<script>

textarea = document.querySelector("#progress_log");
textarea.addEventListener('input', autoResize, false);

function autoResize() {
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
}




    var MTBFChart = null;
   $(document).ready(function() {
    $('#lstview').multiselect();
    getAllattendees();
    var reviewBoardStatusHdn = $("#reviewBoardStatusHdn").val();
    if(reviewBoardStatusHdn != ""){
      $("#meeting_status").val(reviewBoardStatusHdn);
    }
    //getAllActions("17");
    $('#action_due_dat').datepicker({
           autoclose: true,
           format: 'dd/mm/yyyy',
    });
    getChartData();
   });

   function getChartData(){
    var review_board_id = $("#review_board_id").val();
    $.ajax({
     url: "/fracas_admin/review_board/graph/view/",
     method: 'GET',
     dataType: 'json',
     headers: {'X-CSRFToken': '{{ csrf_token }}'},
     data : {
       'review_board_id' : review_board_id
     },
     success: function (response) {
           console.log(response.expected_data);
           var expected_data = response.expected_data;
           var expected_data = {};
           
              getChart(response);
          
           $("#myChart").removeClass("d-none");
           
         }
     });
   }

    function getChart(chartData){
        var timeUnite   = 'month'
        var timeFormat  = 'YYYY-MM-DD';
        var ctx = document.getElementById("myChart").getContext("2d");
        if(MTBFChart != null) MTBFChart.destroy();
        var config = {
            type:    'line',
            data:    {
                datasets: [
                {
                    label: "Failure Data",
                    data: JSON.parse(chartData.chart_data),
                    borderColor: '#0099cc',
                    borderWidth: 2,
                    pointBackgroundColor: '#0099cc',
                    pointBorderColor: '#0099cc',
                    pointRadius: 5,
                    pointHoverRadius: 5,
                    fill: false,
                    tension: 0,
                    showLine: true,
                },
                {
                    label: "Expected Failure Data",
                    data: JSON.parse(chartData.expected_data),
                    borderColor: '#cc0000',
                    borderWidth: 2,
                    pointBackgroundColor: '#cc0000',
                    pointBorderColor: '#cc0000',
                    pointRadius: 5,
                    pointHoverRadius: 5,
                    fill: false,
                    tension: 0,
                    showLine: true,
                }
            ]
            },
            options: {
                responsive: true,
                title:      {
                    display: false,
                    text:    "Cumulative Failure Data",
                    fontSize: 18
                },
                legend: {
                    position: "bottom"
                },
                scales:     {
                    xAxes: [{
                        type:"time",
                        time:{
                            format: timeFormat,
                            tooltipFormat: 'll',
                            unit: timeUnite
                        },
                        scaleLabel: {
                            display:     false,
                            labelString: 'Date'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Cumulative Failure Data'
                        }
                    }]
                }
            }
        };
        
        MTBFChart = new Chart(ctx, config);
        hideloader();

    }
   
   function addEditAttendees(attendees_id){
      $("#addEditAttendeesModal").modal('toggle');
   }

   function addActions(discussion_id){
    $("#addNewAction").modal("toggle");
    $("#review_discussion_id").val(discussion_id);
    $("#actionModalLabel").html("Add New Action");
    $("#saveActionButton").html("Save Action");
    $("#saveActionButton").attr("onclick","SaveAction()");
    getActionOwner(discussion_id);

   }

   function getActionOwner(discussion_id){
    $.ajax({
     url: "/fracas_admin/review_board/defect_discussion/attendees/",
     method: 'GET',
     dataType: 'json',
     headers: {'X-CSRFToken': '{{ csrf_token }}'},
     data : {
       'discussion_id' : discussion_id
     },
     success: function (response) {

        console.log(response.attendees);
        var attendees = response.attendees;
        
        var atHtml = '<option value="">Select Owner</option>';
        $(attendees).each(function(res, atnds){
          var attendeesName = atnds.name;
          atHtml += '<option value="'+ atnds.name +'">'+atnds.name+'</option>';
          //atHtml += '<option value="'+ attendeesName.replace(/\s/g, '') +'">'+atnds.name+'</option>';
        });
        $("#action_owner").html(atHtml);
        //<option value="action_owne">Select Owner</option>
     }

     });
   }
    

   function SaveAction(){

   var discussion_id = $("#review_discussion_id").val();
   var action_description = $("#action_description").val();
   var action_owner = $("#action_owner").val();
   var action_status = $("#action_status").val();
   var action_due_dat = $("#action_due_dat").val();
   var progress_log = $("#progress_log").val();
    $.ajax({
     url: "/fracas_admin/review_board/defect_discussion/action/",
     method: 'POST',
     dataType: 'json',
     headers: {'X-CSRFToken': '{{ csrf_token }}'},
     data : {
       'discussion_id' : discussion_id,
       'action_description':action_description,
       'action_owner' : action_owner,
       'action_status': action_status,
       'action_due_dat':action_due_dat,
       'progress_log':progress_log,
     },
     success: function (response) {
          $("#addNewAction").modal("toggle");
           console.log(response);
           getAllActions(discussion_id);
           $("#action_description").val("");
           $("#action_owner").val("");
           $("#action_status").val("");
           $("#action_due_dat").val("");
           $("#progress_log").val("");
    //        // $("#addReviewModal").modal("togle");
    //        // $(".chart_searchby").show()
    //        // $("#search_type").html(LRU_Type)
    //        // getChart(response)
    //        // $('.nodata').addClass('hide')
    //        // $("#print_chart").removeClass('d-none');
         }
     });
   }

   function getAllActions(discussion_id){
      //var discussion_id = $("#review_discussion_id").val();
      console.log(discussion_id,"mmmmmmmmmmmmmmmm")
      $.ajax({
     url: "/fracas_admin/review_board/defect_discussion/action/",
     method: 'GET',
     dataType: 'json',
     headers: {'X-CSRFToken': '{{ csrf_token }}'},
     data : {
       'discussion_id' : discussion_id
     },
     success: function (response) {
        var actionHtml = "";
        //console.log(response.length);
        actionHtml += '<div class="card" id="rbActions">';
        actionHtml += '<h2 class="mb-4 card-header">Actions ';
          //navTabContents += '<input type="button" class="btn btn-success span-2 mb-4 float-right" value="Add New Action" onclick="addActions('+atData.discussion_id+');">';
        actionHtml += '<a href="javascript:void(0)" onclick="addActions('+discussion_id+');">Add New <i class="fa fa-plus" aria-hidden="true"></i></a>';
        actionHtml += '</h2>';
        var actions = response.data;
        if(actions.length > 0 ){   
          
          actionHtml += '<div class="table-responsive card-body">';
          actionHtml += '<table class="todos_labels table table-striped table-bordered"><thead><tr>';            
          actionHtml += '<th>Action description</th><th>Action owner</th><th>Action status</th><th>Action due date</th><th>Progress log</th><th></th></tr></thead>';
          actionHtml += '<tbody>';
          $(actions).each(function(res, act){
          actionHtml += '<tr><td>'+act.action_description+'</td><td>'+act.action_owner+'</td><td>'+act.action_status+'</td><td>'+act.action_due_dat+'</td><td>'+act.progress_log+'</td>';
          actionHtml += '<th><button type="button" class="btn btn-primary mr-3" onclick="editAction('+act.action_id+','+discussion_id+');"><i class="fa fa-edit" aria-hidden="true"></i></button>';
          actionHtml += '<button type="button" class="btn btn-danger" onclick="deleteAction('+act.action_id+','+discussion_id+');"><i class="fa fa-trash" aria-hidden="true"></i></button></th></tr>';
          });
          actionHtml += '</tbody>';
          actionHtml += '</table>';
          actionHtml += '</div>';         
        }else{
          actionHtml += '<div class="table-responsive card-body">';
          actionHtml += '<div class="alert alert-danger text-center" role="alert">';
          actionHtml += 'No actions created for view !';
          actionHtml += '</div>';
          actionHtml += '</div>';
        }
        actionHtml += '</div>';
        $("#actions_"+discussion_id).html(actionHtml);
     }

     });

   }

   function editAction(action_id, discussion_id){
    //console.log(action_id,"action_id"); 
    $("#action_owner").val('');
    $("#addNewAction").modal("toggle");
    getActionOwner(discussion_id);
    var delete_action = "";
      $.ajax({
         url: "/fracas_admin/review_board/defect_discussion/action/update/",
         method: 'GET',
         dataType: 'json',
         headers: {'X-CSRFToken': '{{ csrf_token }}'},
         data : {
           'action_id' : action_id
         },
         success: function (response) {
           
           var actionData = response.data;
           
           console.log(actionData);

//alert(actionData[0].action_owner);
           $("#action_description").val(actionData[0].action_description);
           setTimeout(function () {
             $("#action_owner").val(actionData[0].action_owner);
           },400);
           
           var attendeesName = actionData[0].action_owner;
           
           //$("#action_owner").val(attendeesName.replace(/\s/g, ''));
           $("#action_status").val(actionData[0].action_status);
           $("#action_due_dat").val(actionData[0].action_due_dat);
           $("#progress_log").val(actionData[0].progress_log);
           //saveActionButton           
           $("#actionModalLabel").html("Edit Action");
           $("#saveActionButton").html("Update Action");
           $("#saveActionButton").attr("onclick","updateAction("+action_id+","+discussion_id+")");
         }
      });
   }

   function updateAction(action_id,discussion_id){
   var delete_action = "";
   var action_description = $("#action_description").val();
   var action_owner = $("#action_owner").val();
   var action_status = $("#action_status").val();
   var action_due_dat = $("#action_due_dat").val();
   var progress_log = $("#progress_log").val();
    $.ajax({
     url: "/fracas_admin/review_board/defect_discussion/action/update/",
     method: 'POST',
     dataType: 'json',
     headers: {'X-CSRFToken': '{{ csrf_token }}'},
     data : {
       'action_description':action_description,
       'action_owner' : action_owner,
       'action_status': action_status,
       'action_due_dat':action_due_dat,
       'progress_log':progress_log,
       'delete_action':delete_action,
       'action_id' : action_id,
     },
     success: function (response) {
          $("#addNewAction").modal("toggle");
           //console.log(response);
           getAllActions(discussion_id);
           $("#action_description").val("");
           $("#action_owner").val("");
           $("#action_status").val("");
           $("#action_due_dat").val("");
           $("#progress_log").val("");
    //        // $("#addReviewModal").modal("togle");
    //        // $(".chart_searchby").show()
    //        // $("#search_type").html(LRU_Type)
    //        // getChart(response)
    //        // $('.nodata').addClass('hide')
    //        // $("#print_chart").removeClass('d-none');
         }
     });
   }

   function deleteAction(action_id,discussion_id){
    var delete_action = "true";
    swal({
            title: "Are you sure?",
            type: "warning",
            showCancelButton: true,
            confirmButtonClass: "btn-danger",
            confirmButtonText: "Yes, delete it!",
            closeOnConfirm: false,
            width: '300px'
        },
        function(){
             $.ajax({
                url: "/fracas_admin/review_board/defect_discussion/action/update/",
                method: 'POST',
                dataType: 'json',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data : {
                  'action_id' : action_id,
                  'delete_action':delete_action
                },
                success: function (response) {
                      swal("Deleted!", "Action has been deleted.");
                    getAllActions(discussion_id)
                }
            });     
        });
   }
   
   function SaveAttendees(){
   
   var attendees = [];
   $("#lstview_to option").each(function(){
      attendees.push($(this).val());
    });
   var defect =  $("#discussion_defect_set").val();
   var review_board_id = $('#review_board_id').val();
   //console.log(attendees);
    $.ajax({
     url: "/fracas_admin/review_board/defect_discussion/",
     method: 'POST',
     dataType: 'json',
     headers: {'X-CSRFToken': '{{ csrf_token }}'},
     data : {
       'attendees' : attendees,
       'defect': defect,
       'review_board_id':review_board_id,
       'discussion_id':''
     },
     success: function (response) {
           console.log(response);
           $('#addEditAttendeesModal').modal("toggle");
           getAllattendees();
    //        // $("#addReviewModal").modal("togle");
    //        // $(".chart_searchby").show()
    //        // $("#search_type").html(LRU_Type)
    //        // getChart(response)
    //        // $('.nodata').addClass('hide')
    //        // $("#print_chart").removeClass('d-none');
         }
     });
   }
   function getAllattendees(){

    var review_board_id = $('input[name="review_board_id"]').val();
    $.ajax({
     url: "/fracas_admin/review_board/defect_discussion/",
     method: 'GET',
     dataType: 'json',
     headers: {'X-CSRFToken': '{{ csrf_token }}'},
     data : {
       'review_board_id' : review_board_id,
       'discussion_id' : ''
     },
     success: function (response) {
           
           var attendees = response.data;
            var dataHtml = "";
            var navListItems = "";
            var navTabContents = "";
            var x = 1;
           $(attendees).each(function(res,atData){
              console.log(atData);
              disc_is = '';
              var activeClass = "active";
              if(x ==1){
                activeClass = "active";
              }else{
                activeClass = "";
              }
              navListItems += '<li class="nav-item nav-link '+activeClass+'">';
              navListItems += '<a class="'+activeClass+' d-inline-block" href="#dicussion_'+atData.discussion_id+'" data-toggle="tab">Discussion '+x+'</a>';
              navListItems += '<a class="d-inline-block ml-2 text-secondary" href="javascript:void(0)" onclick="EditDiscussion('+atData.discussion_id+')"><i class="fa fa-edit" aria-hidden="true"></i></a>';
              navListItems += '<a class="d-inline-block ml-2 text-secondary" href="javascript:void(0)" onclick="DeleteDiscussion('+atData.discussion_id+')"><i class="fa fa-trash" aria-hidden="true"></i></a>';
              navListItems += '</li>';

              navTabContents += '<div class="tab-pane '+activeClass+'" id="dicussion_'+atData.discussion_id+'">';
              navTabContents += '<div class="row pt-4 pb-4">';

              navTabContents += '<div class="col-lg-6">';

              navTabContents += '<div class="card">';

              navTabContents += '<div class="card-body pt-3 pb-1">';
              navTabContents += '<h5 class="card-title pl-0">Attendees</h5>';
              navTabContents += '<div class="card-text">';
              navTabContents += '<ul class="list-inline">';
                var attendees = atData.attendees;
                $(attendees).each(function(d, a){
                  navTabContents += '<li class="list-inline-item rounded border border-secondary mb-2 pl-2 pr-2">'+a.name+'</li>';
                });
              navTabContents += '</ul>';
              navTabContents += '</div>';
              navTabContents += '</div>';

              navTabContents += '</div>';

              navTabContents += '</div>';

              navTabContents += '<div class="col-lg-6">';
              navTabContents += '<div class="card">';
              navTabContents += '<div class="card-body pt-3 pb-1">';
              navTabContents += '<h5 class="card-title pl-0">Defect #'+atData.defect_id+'</h5>';
              navTabContents += '<div class="card-text">';
              navTabContents += '<ul class="list-inline">';
              navTabContents += '<li class="list-inline-item mb-2 pr-2">'+atData.defect_name+'</li>';
              navTabContents += '</ul>';
              navTabContents += '</div>';
              navTabContents += '</div>';
              navTabContents += '</div>';
              navTabContents += '</div>';
              navTabContents += '<div class="col-lg-5 text-align-right">';
                // navTabContents += '<input type="button" class="btn btn-success span-2" value="Edit Discussion" onclick="EditDiscussion('+atData.discussion_id+')"/>';
                // navTabContents += '<input type="button" class="btn btn-danger span-2 ml-4" value="Delete Discussion" onclick="DeleteDiscussion('+atData.discussion_id+')"/>';
              
                //navTabContents += '<input type="button" class="btn btn-success span-2 mb-4 float-right" value="Add New Action" onclick="addActions('+atData.discussion_id+');">';
                navTabContents += '</div>';
              navTabContents += '</div>';
              navTabContents += '<div class="col-sm-12 p-0" id="actions_'+atData.discussion_id+'"></div>';
              navTabContents += '</div>';

              // dataHtml += '<table class="table table-striped table-bordered mt-5" ><thead><tr>';
            
              // dataHtml += '<th colspan="3" style="width: 250px;">Attendees</th><th>Defect</th><th>Add Attendees</th></tr></thead>';
              
              // dataHtml += '<tbody><tr class="row1"><td class="field-attendees" colspan="3">';
              // dataHtml += '<div class="related-widget-wrapper">';             
              // dataHtml += '<div class="col-xs-5">';
              //   var attendees = atData.attendees;
              // $(attendees).each(function(d, a){
              //   dataHtml += a.name;
              // });
              // dataHtml += '</div></div></div></td>';
              // dataHtml += '<td class="field-defect">';
              // dataHtml += '<div class="related-widget-wrapper">'+atData.defect_name;

              // dataHtml += '</div></td>';
              // dataHtml += '<td>';
              // dataHtml += '<input type="button" class="btn btn-success span-2" value="Edit Discussion" onclick="EditDiscussion('+atData.discussion_id+')"/>';
              // dataHtml += '<input type="button" class="btn btn-danger span-2 ml-4" value="Delete Discussion" onclick="DeleteDiscussion('+atData.discussion_id+')"/>';
              // dataHtml += '</td>';
              // dataHtml += '</tbody>';
              // dataHtml += '</table>';
              // dataHtml += '<div class="col-sm-12 text-right">';
              // dataHtml += '<input type="button" class="btn btn-success span-2 mb-4" value="Add New Action" onclick="addActions('+atData.discussion_id+');">';
              // dataHtml += '</div>';
              // dataHtml += '<div class="col-sm-12" id="actions_'+atData.discussion_id+'"></div>';
              getAllActions(atData.discussion_id);
              x++;
           });
           
           $("#navListItems").html(navListItems);
           $("#navTabContents").html(navTabContents);
          //  $("#attendeesListDiv").html(dataHtml);
           
         }
     });
   }

   function EditDiscussion(id){
      $("#EditAttendeesModal").modal("toggle");
      $("#discussionId_edit").val(id);
      var review_board_id = $('input[name="review_board_id"]').val();
      $.ajax({
         url: "/fracas_admin/review_board/defect_discussion/update/",
         method: 'GET',
         dataType: 'json',
         headers: {'X-CSRFToken': '{{ csrf_token }}'},
         data : {
           'review_board_id' : review_board_id,
           'discussion_id' : id
         },
         success: function (response) {
          $('#lstviewEdit').multiselect();
           var discussion = response.data;
           var options = "";
           $(discussion).each(function(res, discsn){
            console.log(discsn);
            var attendeesList = discsn.attendees;
            $(attendeesList).each(function(resp, atndees){
              options += '<option value="'+atndees.employee_id+'">'+atndees.name+'</option>';
              $("#lstviewEdit option[value='"+atndees.employee_id+"']").remove();
            });
            $("#id_defectdiscussion_set").val(discsn.defect_id);

           });
           $('#lstviewEdit_to').html(options);
         }
      });
   }

    function UpdateDiscussion(){
      var delete_action = ""
      var discussion_id = $("#discussionId_edit").val();
      var defect =  $("select[name='id_defectdiscussion_set']").val();
      var attendees = [];
       $("#lstviewEdit_to option").each(function(){
          attendees.push($(this).val());
        });
      var meeting_status = $("#meeting_status").val();
        $.ajax({

           url: "/fracas_admin/review_board/defect_discussion/update/",
           method: 'POST',
           dataType: 'json',
           headers: {'X-CSRFToken': '{{ csrf_token }}'},
           data : {
             'discussion_id' : discussion_id,
             'attendees':attendees,
             'defect':defect,
             'delete_action':delete_action
           },
           success: function (response) {
             console.log(response);
             $('#EditAttendeesModal').modal("toggle");
             getAllattendees();

           }
      });
    }

   function DeleteDiscussion(id){
      var delete_action = "true";
      swal({
            title: "Are you sure?",
            type: "warning",
            showCancelButton: true,
            confirmButtonClass: "btn-danger",
            confirmButtonText: "Yes, delete it!",
            closeOnConfirm: false,
            width: '300px'
        },
        function(){
             $.ajax({
                url: "/fracas_admin/review_board/defect_discussion/update/",
                method: 'POST',
                dataType: 'json',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data : {
                  'discussion_id' : id,
                  'delete_action':delete_action
                },
                success: function (response) {
                      swal("Deleted!", "Discussion has been deleted.");
                    window.location.reload();
                }
            });     
        });
   }

   function saveMeetingData(id,bt){
      var delete_action = ""
      var meeting_outcome = $("#meeting_outcome").val();
      var meeting_status = $("#meeting_status").val();
     
        $.ajax({

           url: "/fracas_admin/review_board/update/",
           method: 'POST',
           dataType: 'json',
           headers: {'X-CSRFToken': '{{ csrf_token }}'},
           data : {
             'review_board_id' : id,
             'delete_action':delete_action,
             'meeting_status':meeting_status,
             'meeting_outcome':meeting_outcome
           },
           success: function (response) {
             if(bt == 1){
              swal({
                  title: 'Successfully update review board',
                  text: "",
                  type: '',
                  showCancelButton: false,
                  confirmButtonColor: '#3085d6',
                  cancelButtonColor: '#d33',
                  confirmButtonText: 'Ok'
              },function () {
                window.location.href = "/forms/review_board/";
              })  

             }else{
              swal({
                  title: 'Successfully update review board',
                  text: "",
                  type: '',
                  showCancelButton: false,
                  confirmButtonColor: '#3085d6',
                  cancelButtonColor: '#d33',
                  confirmButtonText: 'Ok'
              },function () {
                window.location.reload();
              })  
              
             } 
           }
      });
    }

    function deleteMeetingData(id){
      var delete_action = "true";
       swal({
            title: "Are you sure?",
            type: "warning",
            showCancelButton: true,
            confirmButtonClass: "btn-danger",
            confirmButtonText: "Yes, delete it!",
            closeOnConfirm: false,
            width: '300px'
        },
        function(){
             $.ajax({
                 url: "/forms/review_board/delete/",
                  method: 'GET',
                  dataType: 'json',
                  headers: {'X-CSRFToken': '{{ csrf_token }}'},
                  data : {
                      'id':id,
                  },
                  success: function (response) {
                       swal("Deleted!", "Review board has been deleted.");
                      window.location.href = "/forms/review_board/";
                  }
            });     
        });
   }
   
   $(document).ready(function() {
   $('#startDate').datepicker({
     autoclose: true,
     format: 'dd/mm/yyyy',
   });
   $('#toDate').datepicker({
     autoclose: true,
     format: 'dd/mm/yyyy',
   });
   
   });
</script>
{% endblock sb_admin_js %}
