{% extends "django_sb_admin/base.html" %}
<!doctype html>
{% block sb_admin_header %}
  {% block branding %}
    <img src="/static/Riyadh-metro-logo.png" style="background: transparent;width: 60px;">
    <!-- <h1 id="site-name">Asset Optima</h1> -->
  {% endblock %}
{% endblock sb_admin_header %}
{% block sb_admin_content %}
              <!-- Page Heading -->

            <div class="row mb-3">
                <div class="col-lg-6">
                    <h3 class="page-header">
                       Job Card
                    </h3>
                  
                </div>

                 <div class="col-lg-6 mb-3">
    
    
                    <a href="/forms/jobcard_register/"><button class="btn btn-primary btn-icon-split float-right m-2" > 
                    <span class="icon text-white-50">
                        <i class="fas fa-angle-left"></i>
                        </span>             
                    <span class="text">Back</span>
                    </button></a>
                
                </div>

            </div>
            <div class="row " style="padding: 20px;">

                <div class="col-lg-6">
                    <span>Job Card No: <b>{{data.job_card_no}}</b></span><br>
                    <span>Train Set No: <b>{{data.train_set_no}}</b></span><br>
                    <span>Department: <b>{{data.department}}</b></span><br>
                    <span>Nature of Job: <b>{{ data.nature_of_job|default_if_none:"" }}</b></span><br>
                    <span>SIC Required: <b>{{ data.sic_required|default_if_none:"" }}</b></span><br>
                    <span>Assigned To: <b>{{ data.assigned_to|default_if_none:"" }}</b></span><br>
                 
                  
                </div>
                <div class="col-lg-6">
                    <span>Date Issued <b>{{data.date}}</b></span>,
                    <span>Time <b>{{data.time}}</b></span><br>

                    {% if data.status == 0 %}
                        <h3 class="text-success"> Open </h3>
                    {% else %}
                        <h3> Closed </h3>
                    {% endif %}

                    <span>Last Update On <b>{{data.last_update}}</b></span>


                    
                </div>

               

               
            </div>


<hr>
             <div class="row " style="padding: 20px;">
                <div class="col-lg-12"><h3>Failure Data</h3></div>
                
                <div class="col-lg-4">
                    <span>Failure ID: <b>{{data.failure_id}}</b></span><br>
                    <span>Failure description: <b>{{data.event_description}}</b></span><br>
                    <span>Failure type: <b>{{data.failure_type}}</b></span><br><br>

                    <span>Kilometre Reading: <b>{{data.kilometre_reading}}</b></span><br>
                    <span>CAR: <b>{{data.sel_car}}</b></span><br>
                    <span>Equipment: <b>{{data.equipment}}</b></span><br>
                    <span>Location: <b>{{data.location}}</b></span><br>
                    <span>Direction: <b>{{data.direction}}</b></span><br>

                </div>

                <div class="col-lg-4">
                    <span>Asset Name: <b>{{data.asset_type}}</b></span><br>
                    <span>Asset Config ID: <b>{{data.asset_config_id}}</b></span><br>
                    <span>Train Set No: <b>{{data.train_set_no}}</b></span><br><br>
                    
                    <span>Incident: <b>{{data.incident}}</b></span><br>
                    <span>No. of Trips Cancelled: <b>{{data.no_of_trip_cancel}}</b></span><br>
                    <span>Deboarding: <b>{{data.deboarding}}</b></span><br>
                    <span>Reported to PPIO: <b>{{data.reported_to_PPIO}}</b></span><br>
                    <span>T.O. Name / Reported By: <b>{{data.TO_name}}</b></span><br>

                </div>
                <div class="col-lg-4">
                    <span>Failure detection: <b>{{data.detection}}</b></span><br>
                    <span>Delay Time (mins): <b>{{data.service_delay}}</b></span><br>
                    <span>Safety failure: <b>{{data.safety_failure}}</b></span><br><br>

                    <span>Cm start date : <b>{{data.cm_start_date}}</b></span><br>
                    <span>Cm start time: <b>{{data.cm_start_time}}</b></span><br>
                    <span>Cm end date : <b>{{data.cm_end_date}}</b></span><br>
                    <span>Cm end time: <b>{{data.cm_end_time}}</b></span><br>
                    <span>Cm description: <b>{{data.cm_description}}</b></span><br>

                </div>
                <div class="col-lg-12"><br>
                    <span>Immediate Action Taken: <b>{{data.immediate_investigation}}</b></span><br>
                </div>



             </div>

             <hr>
             

             {% if data.run_status == 0 and request.session.user_Role == 5 %}

                <div class="row " style="padding: 20px;text-align: center;">
                    <div class="col-lg-12 " >
                        <h5>LEVEL 1 Job Card Details (To be filled by PPIO) (Pune Metro)</h5>
                        
                    </div>

                </div>

                <form id="Level1JobCard"> 
                    <div class="row mb-4">


                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="ohe_required">*OHE Required :</label>
                                <select class="form-control" id="ohe_required " name="ohe_required" required="required">
                                    {% if 'Yes' == data.ohe_required %}
                                    <option value="Yes" selected>Yes</option>
                                    {% else %}
                                        <option value="Yes">Yes</option>
                                    {% endif %}
                                    {% if 'No' == data.ohe_required %}
                                    <option value="No" selected>No</option>
                                    {% else %}
                                        <option value="No">No</option>
                                    {% endif %}
                                </select>
                                {% comment %} <input type="text" class="form-control" id="ohe_required" name="ohe_required" value="{{data.ohe_required}}"> {% endcomment %}
                                <div class="invalid-feedback">
                                Please select OHE Required .
                                </div>
                            </div>
                        </div>


                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="issued_to">*Issued to:</label>
                                <input type="text" class="form-control" id="issued_to" required="required" name="issued_to" value="{{data.issued_to}}">
                                <div class="invalid-feedback">
                                Please enter Issued to.
                                </div>
                            </div>
                        </div>

                             <div class="col-md-4">
                            <div class="form-group">
                                <label for="completion_time">*Expected Time of Completion:</label>
                                <input type="time" class="form-control" required="required" id="completion_time" name="completion_time" value="{{data.completion_time|date:"H:i:s"}}">
                                <div class="invalid-feedback">
                                Please enter Expected Time of Completion.
                                </div>
                            </div>
                        </div>


                         <div class="col-md-4">
                            <div class="form-group">
                                <label for="from_revenue_service">*Train Withdrawn from Revenue Service :</label>
                                <select class="form-control" id="from_revenue_service " name="from_revenue_service" required="required" onchange="showRevenueService();">
                                    {% if 'Yes' == data.from_revenue_service %}
                                    <option value="Yes" selected>Yes</option>
                                    {% else %}
                                        <option value="Yes">Yes</option>
                                    {% endif %}
                                    {% if 'No' == data.from_revenue_service %}
                                    <option value="No" selected>No</option>
                                    {% else %}
                                        <option value="No">No</option>
                                    {% endif %}
                                </select>
                                {% comment %} <input type="text" class="form-control" id="from_revenue_service" name="from_revenue_service" value="{{data.from_revenue_service}}"> {% endcomment %}
                                <div class="invalid-feedback">
                                Please select Train Withdrawn from Revenue Service .
                                </div>
                            </div>
                        </div>



                            <div class="col-md-4 d-none" id="revenue_service_div1">
                                <div class="form-group">
                                    <label for="delay_to_service">*Delay to Service:</label>
                                    <input type="time" class="form-control" id="delay_to_service" name="delay_to_service" value="{{data.delay_to_service|date:"H:i:s"}}">
                                    <div class="invalid-feedback">
                                    Please enter Delay to Service.
                                    </div>
                                </div>
                            </div>


                            <div class="col-md-4 d-none" id="revenue_service_div2">
                                <div class="form-group">
                                    <label for="trip_no">*Trip No:</label>
                                    <input type="text" class="form-control" id="trip_no"  name="trip_no" value="{{data.trip_no}}">
                                    <div class="invalid-feedback">
                                    Please enter Trip No.
                                    </div>
                                </div>
                            </div>



                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="nature_of_job">*Nature of Job:</label>
                                
                                    <select class="form-control" id="nature_of_job" name="nature_of_job" required="required">
                                        {% if 'Schedule Preventive Maintenance' == data.nature_of_job %}
                                        <option value="Schedule Preventive Maintenance" selected>Schedule Preventive Maintenance</option>
                                        {% else %}
                                            <option value="Schedule Preventive Maintenance">Schedule Preventive Maintenance</option>
                                        {% endif %}
                                        {% if 'Main Line Fault' == data.nature_of_job %}
                                        <option value="Main Line Fault" selected>Main Line Fault</option>
                                        {% else %}
                                            <option value="Main Line Fault">Main Line Fault</option>
                                        {% endif %}

                                        {% if 'Depot Fault' == data.nature_of_job %}
                                        <option value="Depot Fault" selected>Depot Fault</option>
                                        {% else %}
                                            <option value="Depot Fault">Depot Fault</option>
                                        {% endif %}

                                        {% if 'Cyclic Check' == data.nature_of_job %}
                                        <option value="Cyclic Check" selected>Cyclic Check</option>
                                        {% else %}
                                            <option value="Cyclic Check">Cyclic Check</option>
                                        {% endif %}

                                        {% if 'Overhaul' == data.nature_of_job %}
                                        <option value="Overhaul" selected>Overhaul</option>
                                        {% else %}
                                            <option value="Overhaul">Overhaul</option>
                                        {% endif %}
                                    
                                    </select>




                                    {% comment %} <input type="text" class="form-control" id="nature_of_job" name="nature_of_job" value="{{data.nature_of_job}}"> {% endcomment %}
                                    <div class="invalid-feedback">
                                    Please enter Nature of Job.
                                    </div>
                                </div>
                            </div>



                              <div class="col-md-4">
                                <div class="form-group">
                                    <label for="event_date">*Event Date (DD/MM/YYYY):</label>
                                    <input type="text" autocomplete="off" required="required" class="form-control date-time" id="event_date" name="event_date" value="{{data.event_date|date:'d/m/Y'}}">
                                    <div class="invalid-feedback">
                                    Please enter Event Date.
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="event_time">*Event Time:</label>
                                    <input type="time" class="form-control" id="event_time" required="required" name="event_time" value="{{data.event_time|date:"H:i:s"}}">
                                    <div class="invalid-feedback">
                                    Please enter Event Time.
                                    </div>
                                </div>
                            </div>


                             <div class="col-12">  
                                <button type="submit" class="btn btn-primary mt-2" >Update</button>

                            </div>








                    </div>



                </form>
                


            {% else %}

                {% if data.run_status > 0 %}


                    <div class="row " style="padding: 20px;">
                        <div class="col-lg-12"><h3>LEVEL 1 Job Card Details (To be filled by PPIO) (Pune Metro)</h3></div>

                        <div class="col-lg-4">
                            <span>OHE Required: <b>{{data.ohe_required}}</b></span><br>
                            <span>Issued to: <b>{{data.issued_to}}</b></span><br>
                            <span>Expected Time of Completion: <b>{{data.completion_time}}</b></span><br><br>

                            <span>Train Withdrawn from Revenue Service: <b>{{data.from_revenue_service}}</b></span><br>

                            {% if data.from_revenue_service == 'Yes' %}
                                <span>Delay to Service: <b>{{data.delay_to_service}}</b></span><br>
                                <span>Trip No: <b>{{data.trip_no}}</b></span><br>                 
                            {% endif %}



                        </div>
                        <div class="col-lg-4">

                            <span>Nature of Job: <b>{{data.nature_of_job}}</b></span><br>
                            <span>Event Date: <b>{{data.event_date}}</b></span><br>
                            <span>Event Time: <b>{{data.event_time}}</b></span><br>

                        </div>

                        {% if request.session.user_Role == 5 %}

                        <div class="col-lg-4">
                            <input type="button" value="Edit LEVEL 1 Job Card Details" class="btn btn-primary" onClick="editJobCardDetails()">
                        </div>

                        {% endif %}


                    </div>



                    {% if data.run_status == 1 and request.session.user_Role == 1 %}

                        <div class="row " style="padding: 20px;text-align: center;">
                            <div class="col-lg-12 " >
                                <h5>LEVEL 1 Details Of Job(s) to be carried out</h5>
                                
                            </div>

                            
                                {% if request.session.user_Role == 5 %}

                                    <div class="col-lg-12 " align="right">
                                        <input type="button" value="Add new Job Details" class="btn btn-primary" onClick="createNewJobDetails();">
                                    </div>

                                {% endif %}
                         

                        </div>



                         <div class="row " style="padding: 20px;text-align: center;">
                            <div class="col-md-12">
                                <table id="example" class="table stripe row-border order-column table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                           
                                            <th>S. No</th>
                                            <th>Car No</th>
                                            <th>Sub System</th>
                                            <th>Equipment</th>
                                            <th>Job Details</th>
                                           
                                            <th class="bg-white">
                                                
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>


                                     {% for job_details in job_details %}
                                            <tr>
                                                <td>{{ job_details.s_no }}</td>
                                                <td>{{ data.sel_car }}</td>
                                                <td>{{ data.subsystem }}</td>
                                                <td>{{ data.equipment }}</td>
                                                <td>{{ job_details.job_description }}</td>

                                                
                                                <td class="bg-white">

                                                    {% if request.session.user_Role == 1 %}

                                        <input type="button" value="Edit" onClick="editJobDetails('{{ job_details.job_details_id }}',`{{ job_details.s_no }}`,`{{ job_details.job_description }}`);">

                                        <input type="button" value="Delete" onClick="deleteJobDetails('{{ job_details.job_details_id }}');">


                                                    {% endif %}

                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">No job details available</td>
                                            </tr>
                                        {% endfor %}

                                        





                                    </tbody>
                                </table>
                            </div>
                        </div>





                    {% else %}

                        <h1>here</h1>

                    {% endif %}


                {% endif %}




            {% endif %}


<!-- Modal HTML -->
<!-- Large Modal -->
<div class="modal fade" id="myModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"> <!-- modal-lg makes it large -->
    <div class="modal-content">

         <form id="JobDetailsForm"> 
    
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title">Job Details</h5>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">

        <div class="row mb-4">

            <div class="col-sm-6">
                <div class="form-group">
                    <label for="s_no">*S. No:</label>
                    <input type="text" class="form-control" required="required" id="s_no" name="s_no" value="">
                    <div class="invalid-feedback">
                        Please enter S. No.
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label for="car_no">*Car No:</label>
                    <input type="text" class="form-control" required="required" id="car_no" name="car_no" value="{{data.sel_car}}" readonly>
                    <div class="invalid-feedback">
                        Please enter Car No.
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label for="sub_sym">*Sub System:</label>
                    <input type="text" class="form-control" required="required" id="sub_sym" name="sub_sym" value="{{data.subsystem}}" readonly>
                    <div class="invalid-feedback">
                        Please enter Sub System.
                    </div>
                </div>
            </div>

             <div class="col-sm-6">
                <div class="form-group">
                    <label for="inp_equipment">*Equipment:</label>
                    <input type="text" class="form-control" required="required" id="inp_equipment" name="inp_equipment" value="{{data.equipment}}" readonly>
                    <div class="invalid-feedback">
                        Please enter Equipment.
                    </div>
                </div>
            </div>

             <div class="col-sm-12">
                    <div class="form-group">
                        <label for="job_description">*Job Details:</label>
                        <textarea class="form-control" required="required" id="job_description" name="job_description"></textarea>
                         <div class="invalid-feedback">
                         Please enter Job Details.
                        </div>
                    </div>
                </div>





        </div>


        
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModal();">Close</button>
        <button type="submit" class="btn btn-primary">Save</button>
        <input type="hidden" value="" id="JobDetailsID" name="JobDetailsID">
      </div>

      </form>

    </div>
  </div>
</div>

           
            
{% endblock sb_admin_content %}
{% block sb_admin_js %}
<script>

     var myModal = new bootstrap.Modal(document.getElementById('myModal'));

    $(document).ready(function() {

          $('#event_date').datepicker({
          autoclose: true,
          format: 'dd/mm/yyyy',});

        showRevenueService();
    });

    $( "#JobDetailsForm" ).submit(function(e) {
        e.preventDefault();

        var job_description= $('#job_description').val()
        var s_no= $('#s_no').val()
        var JobDetailsID= $('#JobDetailsID').val()

        job_description = job_description.replace(/['"`]/g, '');

        var id= '{{data.id}}';

        $.ajax({
            url: "/forms/jobcard_register/addjobcard/",
            method: 'POST',
            dataType: 'json',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            data : {
                'id':id,
                'job_description' : job_description,
                's_no':s_no,
                'JobDetailsID':JobDetailsID,
                'st':15,
            },

            success: function (response) {
                if(response.status == '1') {
                    window.location.reload(); 
                }
                else{
                    swal('Failed to save Job Details')
                    
                }
            }
        });
        


    });

    function createNewJobDetails(){
       $('#JobDetailsID').val('');
       $('#job_description').val('');
       $('#s_no').val('');
        myModal.show();
    }

    function editJobDetails(id,s_no,job_description){

         $('#JobDetailsID').val(id);
       $('#job_description').val(job_description);
       $('#s_no').val(s_no);
        myModal.show();

    }

    function deleteJobDetails(id){

         swal({
            title: "Are you sure?",
            type: "warning",
            showCancelButton: true,
            confirmButtonClass: "btn-danger",
            confirmButtonText: "yes, delete it!",
            closeOnConfirm: false,
            width: '300px'
        },
        function(){
             $.ajax({
                url: "/forms/jobcard_register/addjobcard/",
                method: 'POST',
                dataType: 'json',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data : {
                    'id':id,
                    'st':16,
                },
                success: function (response) {
                    window.location.reload(); 
                }
            });     
        });

    }

    function closeModal(){
       myModal.hide();
    }

    function editJobCardDetails(){
        var id= '{{data.id}}';

         swal({
            title: "Are you sure?",
            text:"If you update LEVEL 1 Job Card Details, the status of this job card will be reset.",
            type: "warning",
            showCancelButton: true,
            confirmButtonClass: "btn-danger",
            confirmButtonText: "Ok, update it!",
            closeOnConfirm: false,
            width: '300px'
        },
        function(){
             $.ajax({
                url: "/forms/jobcard_register/addjobcard/",
                method: 'POST',
                dataType: 'json',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data : {
                    'id':id,
                    'st':0,
                },
                success: function (response) {
                    window.location.reload(); 
                }
            });     
        });
    }

    function showRevenueService(){
        var from_revenue_service= $('select[name=from_revenue_service] option').filter(':selected').val()

        if(from_revenue_service == 'Yes'){
            $('#revenue_service_div1').removeClass('d-none')
            $('#revenue_service_div2').removeClass('d-none')
        }else{
            $('#revenue_service_div1').addClass('d-none')
            $('#revenue_service_div2').addClass('d-none')
        }
    }





     $( "#Level1JobCard" ).submit(function(e) {
        e.preventDefault();

        var ohe_required= $('select[name=ohe_required] option').filter(':selected').val()
        var issued_to= $('#issued_to').val()
        var completion_time= $('#completion_time').val()
        var from_revenue_service= $('select[name=from_revenue_service] option').filter(':selected').val()
        var delay_to_service= $('#delay_to_service').val()
        var trip_no= $('#trip_no').val()
        var nature_of_job= $('select[name=nature_of_job] option').filter(':selected').val()
        var event_date= $('#event_date').val()
        var event_time= $('#event_time').val()

        if(from_revenue_service == 'No'){
            delay_to_service= '';
            trip_no='';
        }else{
            if(delay_to_service == ''){
                $('#delay_to_service').focus()
                return false;
            }

            if(trip_no == ''){
                $('#trip_no').focus()
                return false;
            }

        }

        var id= '{{data.id}}';

        $.ajax({
            url: "/forms/jobcard_register/addjobcard/",
            method: 'POST',
            dataType: 'json',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            data : {
               
                'id':id,
                'ohe_required' : ohe_required,
                'issued_to':issued_to,
                'completion_time':completion_time,
                'from_revenue_service':from_revenue_service,
                'delay_to_service':delay_to_service,
                'trip_no':trip_no,
                'nature_of_job':nature_of_job,
                'event_date':event_date,
                'event_time':event_time,
                'st':1,
            },

            success: function (response) {
                if(response.status == '1') {
                    window.location.reload(); 
                }
                else{
                    swal('Failed to update LEVEL 1 Job Card Details (To be filled by PPIO) (Pune Metro)')
                    
                }
            }
        });
        
    });

   
</script>

{% endblock sb_admin_js %}
